<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python脚本监控工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h2 {
            color: #555;
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .btn {
            padding: 6px 12px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-start {
            background-color: #28a745;
            color: white;
        }
        .btn-stop {
            background-color: #dc3545;
            color: white;
        }
        .btn-view {
            background-color: #007bff;
            color: white;
        }
        .btn-stream {
            background-color: #6f42c1;
            color: white;
        }
        .btn-connect {
            background-color: #17a2b8;
            color: white;
        }
        .btn-disconnect {
            background-color: #ffc107;
            color: black;
        }
        .btn-execute {
            background-color: #6f42c1;
            color: white;
        }
        .btn-console {
            background-color: #20c997;
            color: white;
        }
        .btn-debug {
            background-color: #fd7e14;
            color: white;
        }
        .btn-config {
            background-color: #6c757d;
            color: white;
        }
        .btn-refresh {
            background-color: #6c757d;
            color: white;
        }
        .btn-auto-refresh {
            background-color: #17a2b8;
            color: white;
        }
        .btn-auto-refresh.active {
            background-color: #007bff;
        }
        .btn-pagination {
            background-color: #6c757d;
            color: white;
            padding: 5px 10px;
            margin: 0 2px;
        }
        .btn-pagination.active {
            background-color: #007bff;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .status-running {
            color: #28a745;
            font-weight: bold;
        }
        .status-stopped {
            color: #dc3545;
            font-weight: bold;
        }
        .log-container {
            background-color: #000;
            color: #00ff00;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .refresh-btn {
            background-color: #6c757d;
            color: white;
            padding: 8px 16px;
            float: right;
        }
        .clear {
            clear: both;
        }
        .notification {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .notification.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .notification.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .log-title {
            font-weight: bold;
        }
        .auto-scroll-btn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .auto-scroll-btn.active {
            background-color: #007bff;
        }
        .ssh-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .ssh-form-full {
            grid-column: span 2;
        }
        .ssh-form input, .ssh-form select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .command-input {
            display: flex;
            margin-top: 10px;
        }
        .command-input input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .command-input button {
            margin-left: 10px;
        }
        .ssh-connection {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        .console-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        .console-window {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            background-color: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }
        .console-header {
            padding: 10px;
            background-color: #343a40;
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .console-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            height: calc(100% - 40px); /* 减去header的高度 */
        }
        .console-output {
            flex-grow: 1;
            background-color: #000;
            color: #00ff00;
            padding: 10px;
            font-family: monospace;
            overflow-y: auto;
            margin-bottom: 10px;
            white-space: pre-wrap;
            min-height: 0; /* 允许收缩 */
        }
        .console-input-area {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .console-input {
            display: flex;
            margin-bottom: 10px;
        }
        .console-input input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .console-input button {
            margin-left: 10px;
        }
        .close-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .debug-section {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .debug-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .debug-buttons .btn {
            font-size: 12px;
            padding: 4px 8px;
        }
        .config-form {
            margin-bottom: 20px;
        }
        .config-item {
            margin-bottom: 10px;
        }
        .config-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .config-item input, .config-item textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .config-item textarea {
            height: 100px;
            font-family: monospace;
        }
        .path-list {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 5px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .pagination-info {
            text-align: center;
            margin-bottom: 10px;
            color: #666;
        }
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .info-card {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        .info-card h3 {
            margin-top: 0;
            color: #555;
        }
        .info-item {
            margin-bottom: 8px;
        }
        .info-label {
            font-weight: bold;
            display: inline-block;
            width: 100px;
        }
        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
        }
        .progress-fill.warning {
            background-color: #ffc107;
        }
        .progress-fill.danger {
            background-color: #dc3545;
        }
        .system-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .system-info-title {
            font-weight: bold;
            font-size: 18px;
        }
        .process-table {
            width: 100%;
            font-size: 12px;
        }
        .process-table th, .process-table td {
            padding: 4px 6px;
        }
        .disk-info-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .disk-info-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Python脚本监控工具</h1>
        
        <div id="notification-area"></div>
        
        <!-- 系统信息区域 -->
        <div class="section">
            <div class="system-info-header">
                <div class="system-info-title">本机基本信息</div>
                <div>
                    <button id="refreshSystemInfo" class="btn btn-refresh">刷新</button>
                    <button id="autoRefreshSystemInfo" class="btn btn-auto-refresh">自动刷新</button>
                </div>
            </div>
            <div class="system-info">
                <div class="info-card">
                    <h3>CPU信息</h3>
                    <div class="info-item">
                        <span class="info-label">使用率:</span>
                        <span id="cpuPercent">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">核心数:</span>
                        <span id="cpuCount">--</span>
                    </div>
                    <div class="progress-bar">
                        <div id="cpuProgress" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <h4>Top 5 进程</h4>
                    <table class="process-table">
                        <thead>
                            <tr>
                                <th>PID</th>
                                <th>进程名</th>
                                <th>CPU%</th>
                            </tr>
                        </thead>
                        <tbody id="cpuProcesses">
                            <tr><td colspan="3">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="info-card">
                    <h3>内存信息</h3>
                    <div class="info-item">
                        <span class="info-label">使用率:</span>
                        <span id="memoryPercent">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">已使用:</span>
                        <span id="memoryUsed">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">总计:</span>
                        <span id="memoryTotal">--</span>
                    </div>
                    <div class="progress-bar">
                        <div id="memoryProgress" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <h4>Top 5 进程</h4>
                    <table class="process-table">
                        <thead>
                            <tr>
                                <th>PID</th>
                                <th>进程名</th>
                                <th>内存%</th>
                            </tr>
                        </thead>
                        <tbody id="memoryProcesses">
                            <tr><td colspan="3">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="info-card">
                    <h3>磁盘信息</h3>
                    <div id="diskInfo">
                        加载中...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="local">本地脚本管理</div>
            <div class="tab" data-tab="ssh">SSH远程连接</div>
            <div class="tab" data-tab="config">配置管理</div>
        </div>
        
        <div id="local-tab" class="tab-content active">
            <div class="section">
                <h2>运行中的脚本</h2>
                <button id="refreshRunning" class="btn refresh-btn">刷新</button>
                <div class="clear"></div>
                <table id="runningTable">
                    <thead>
                        <tr>
                            <th>PID</th>
                            <th>脚本名称</th>
                            <th>完整路径</th>
                            <th>启动时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 动态填充数据 -->
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>所有脚本</h2>
                <button id="refreshScripts" class="btn refresh-btn">刷新</button>
                <div class="clear"></div>
                <div class="pagination-info" id="scriptsPaginationInfo"></div>
                <table id="scriptsTable">
                    <thead>
                        <tr>
                            <th>脚本名称</th>
                            <th>相对路径</th>
                            <th>完整路径</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 动态填充数据 -->
                    </tbody>
                </table>
                <div class="pagination" id="scriptsPagination"></div>
            </div>
            
            <div class="section">
                <div class="log-header">
                    <div class="log-title">脚本日志</div>
                    <button id="autoScrollBtn" class="auto-scroll-btn active">自动滚动</button>
                </div>
                <div id="logContent" class="log-container">
                    选择一个脚本以查看日志
                </div>
                <div style="margin-top: 10px;">
                    <button id="refreshLogsBtn" class="btn btn-view">刷新日志</button>
                    <button id="streamLogsBtn" class="btn btn-stream">实时日志</button>
                </div>
            </div>
        </div>
        
        <div id="ssh-tab" class="tab-content">
            <div class="section">
                <h2>SSH连接配置</h2>
                <form id="sshConfigForm">
                    <div class="ssh-form">
                        <div>
                            <label>连接名称:</label>
                            <input type="text" id="connName" placeholder="例如: server1">
                        </div>
                        <div>
                            <label>主机地址:</label>
                            <input type="text" id="sshHost" placeholder="例如: 192.168.1.100">
                        </div>
                        <div>
                            <label>端口:</label>
                            <input type="number" id="sshPort" value="22">
                        </div>
                        <div>
                            <label>用户名:</label>
                            <input type="text" id="sshUsername" placeholder="例如: ubuntu">
                        </div>
                        <div>
                            <label>认证方式:</label>
                            <select id="authMethod">
                                <option value="password">密码</option>
                                <option value="key">密钥文件</option>
                            </select>
                        </div>
                        <div id="passwordField">
                            <label>密码:</label>
                            <input type="password" id="sshPassword" placeholder="输入密码">
                        </div>
                        <div id="keyFileField" style="display:none;">
                            <label>密钥文件路径:</label>
                            <input type="text" id="sshKeyFile" placeholder="例如: ~/.ssh/id_rsa">
                        </div>
                        <div class="ssh-form-full">
                            <button type="button" id="saveConnection" class="btn btn-connect">保存连接</button>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="section">
                <h2>已保存的连接</h2>
                <button id="refreshConnections" class="btn refresh-btn">刷新</button>
                <div class="clear"></div>
                <div id="savedConnections">
                    <!-- 动态填充连接 -->
                </div>
            </div>
        </div>
        
        <div id="config-tab" class="tab-content">
            <div class="section">
                <h2>监控配置</h2>
                <form id="monitorConfigForm">
                    <div class="config-form">
                        <div class="config-item">
                            <label>监控路径 (每行一个路径):</label>
                            <textarea id="monitorPaths" placeholder="例如:
.
/home/user/scripts
C:\Users\user\Documents\projects"></textarea>
                            <div class="path-list" id="resolvedPaths">
                                解析后的路径将显示在这里
                            </div>
                        </div>
                        <div class="config-item">
                            <label>排除模式 (每行一个模式):</label>
                            <textarea id="excludePatterns" placeholder="例如:
monitor.py
test_*.py
*_test.py"></textarea>
                        </div>
                        <button type="button" id="saveMonitorConfig" class="btn btn-config">保存配置</button>
                        <button type="button" id="loadMonitorConfig" class="btn btn-config">加载配置</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- SSH控制台弹窗 -->
    <div id="consoleModal" class="console-container">
        <div class="console-window">
            <div class="console-header">
                <div id="consoleTitle">SSH控制台</div>
                <button class="close-btn" onclick="closeConsole()">关闭</button>
            </div>
            <div class="console-body">
                <div id="consoleOutput" class="console-output"></div>
                <div class="console-input-area">
                    <div class="console-input">
                        <input type="text" id="consoleCommand" placeholder="输入命令..." onkeypress="if(event.keyCode==13) sendCommand()">
                        <button class="btn btn-execute" onclick="sendCommand()">执行</button>
                        <button class="btn btn-debug" onclick="toggleDebugMode()">调试模式</button>
                    </div>
                    <div id="debugSection" class="debug-section" style="display: none;">
                        <h4>调试工具</h4>
                        <div class="debug-buttons">
                            <button class="btn btn-debug" onclick="sendDebugCommand('ps aux | grep python')">查看Python进程</button>
                            <button class="btn btn-debug" onclick="sendDebugCommand('ls -la')">列出文件</button>
                            <button class="btn btn-debug" onclick="sendDebugCommand('pwd')">当前目录</button>
                            <button class="btn btn-debug" onclick="sendDebugCommand('df -h')">磁盘使用情况</button>
                            <button class="btn btn-debug" onclick="sendDebugCommand('top -bn1 | head -20')">系统状态</button>
                            <button class="btn btn-debug" onclick="sendDebugCommand('netstat -tulpn')">网络连接</button>
                            <button class="btn btn-debug" onclick="sendDebugCommand('free -h')">内存使用</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 显示通知消息
        function showNotification(message, type) {
            const notificationArea = document.getElementById('notification-area');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            notificationArea.innerHTML = '';
            notificationArea.appendChild(notification);
            
            // 3秒后自动移除通知
            setTimeout(() => {
                if (notification.parentNode === notificationArea) {
                    notificationArea.removeChild(notification);
                }
            }, 3000);
        }
        
        // 系统信息相关变量
        let systemInfoInterval = null;
        let isAutoRefreshSystemInfo = false;
        
        // 获取系统信息
        function getSystemInfo() {
            fetch('/api/system/info')
                .then(response => response.json())
                .then(data => {
                    // 更新CPU信息
                    document.getElementById('cpuPercent').textContent = data.cpu.percent.toFixed(1) + '%';
                    document.getElementById('cpuCount').textContent = data.cpu.count;
                    document.getElementById('cpuProgress').style.width = data.cpu.percent + '%';
                    
                    // 根据CPU使用率设置进度条颜色
                    const cpuProgress = document.getElementById('cpuProgress');
                    cpuProgress.className = 'progress-fill';
                    if (data.cpu.percent > 80) {
                        cpuProgress.classList.add('danger');
                    } else if (data.cpu.percent > 60) {
                        cpuProgress.classList.add('warning');
                    }
                    
                    // 更新内存信息
                    document.getElementById('memoryPercent').textContent = data.memory.percent.toFixed(1) + '%';
                    document.getElementById('memoryUsed').textContent = formatBytes(data.memory.used);
                    document.getElementById('memoryTotal').textContent = formatBytes(data.memory.total);
                    document.getElementById('memoryProgress').style.width = data.memory.percent + '%';
                    
                    // 根据内存使用率设置进度条颜色
                    const memoryProgress = document.getElementById('memoryProgress');
                    memoryProgress.className = 'progress-fill';
                    if (data.memory.percent > 80) {
                        memoryProgress.classList.add('danger');
                    } else if (data.memory.percent > 60) {
                        memoryProgress.classList.add('warning');
                    }
                    
                    // 更新磁盘信息
                    const diskInfoElement = document.getElementById('diskInfo');
                    diskInfoElement.innerHTML = '';
                    data.disks.forEach(disk => {
                        const diskElement = document.createElement('div');
                        diskElement.className = 'disk-info-item';
                        diskElement.innerHTML = `
                            <div><strong>${disk.device}</strong> 挂载点: ${disk.mountpoint}</div>
                            <div class="info-item">
                                <span class="info-label">使用率:</span>
                                <span>${disk.percent.toFixed(1)}%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">已使用:</span>
                                <span>${formatBytes(disk.used)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">总计:</span>
                                <span>${formatBytes(disk.total)}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill${disk.percent > 90 ? ' danger' : disk.percent > 80 ? ' warning' : ''}" 
                                     style="width: ${disk.percent}%"></div>
                            </div>
                        `;
                        diskInfoElement.appendChild(diskElement);
                    });
                    
                    // 更新CPU进程信息
                    const cpuProcessesElement = document.getElementById('cpuProcesses');
                    cpuProcessesElement.innerHTML = '';
                    data.top_processes.cpu.slice(0, 5).forEach(proc => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${proc.pid}</td>
                            <td>${proc.name}</td>
                            <td>${proc.cpu_percent.toFixed(1)}</td>
                        `;
                        cpuProcessesElement.appendChild(row);
                    });
                    
                    // 更新内存进程信息
                    const memoryProcessesElement = document.getElementById('memoryProcesses');
                    memoryProcessesElement.innerHTML = '';
                    data.top_processes.memory.slice(0, 5).forEach(proc => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${proc.pid}</td>
                            <td>${proc.name}</td>
                            <td>${proc.memory_percent.toFixed(1)}</td>
                        `;
                        memoryProcessesElement.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching system info:', error);
                });
        }
        
        // 格式化字节大小
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 切换系统信息自动刷新
        function toggleAutoRefreshSystemInfo() {
            const button = document.getElementById('autoRefreshSystemInfo');
            isAutoRefreshSystemInfo = !isAutoRefreshSystemInfo;
            
            if (isAutoRefreshSystemInfo) {
                button.classList.add('active');
                button.textContent = '停止自动刷新';
                systemInfoInterval = setInterval(getSystemInfo, 5000); // 每5秒刷新一次
            } else {
                button.classList.remove('active');
                button.textContent = '自动刷新';
                clearInterval(systemInfoInterval);
            }
        }
        
        // 标签页切换
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // 移除所有活动状态
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // 激活当前标签页
                this.classList.add('active');
                document.getElementById(this.getAttribute('data-tab') + '-tab').classList.add('active');
            });
        });
        
        // SSH认证方式切换
        document.getElementById('authMethod').addEventListener('change', function() {
            if (this.value === 'password') {
                document.getElementById('passwordField').style.display = 'block';
                document.getElementById('keyFileField').style.display = 'none';
            } else {
                document.getElementById('passwordField').style.display = 'none';
                document.getElementById('keyFileField').style.display = 'block';
            }
        });
        
        // 获取运行中的进程
        function getRunningProcesses() {
            fetch('/api/processes')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector('#runningTable tbody');
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5">没有正在运行的Python脚本</td></tr>';
                        return;
                    }
                    
                    data.forEach(proc => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${proc.pid}</td>
                            <td>${proc.script_name}</td>
                            <td>${proc.script_path}</td>
                            <td>${proc.start_time}</td>
                            <td>
                                <button class="btn btn-view" onclick="viewLogs(${proc.pid})">查看日志</button>
                                <button class="btn btn-stream" onclick="streamLogs(${proc.pid})">实时日志</button>
                                <button class="btn btn-stop" onclick="stopScript(${proc.pid})">停止</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching processes:', error);
                    showNotification('获取运行进程信息时出错', 'error');
                });
        }
        
        // 脚本分页相关变量
        let allScripts = [];
        let currentPage = 1;
        const scriptsPerPage = 5;
        
        // 获取所有脚本
        function getAllScripts() {
            fetch('/api/scripts')
                .then(response => response.json())
                .then(data => {
                    allScripts = data;
                    currentPage = 1;
                    displayScriptsPage(currentPage);
                    setupScriptsPagination();
                })
                .catch(error => {
                    console.error('Error fetching scripts:', error);
                    showNotification('获取脚本列表时出错', 'error');
                });
        }
        
        // 显示指定页的脚本
        function displayScriptsPage(page) {
            const tbody = document.querySelector('#scriptsTable tbody');
            tbody.innerHTML = '';
            
            if (allScripts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">没有找到Python脚本</td></tr>';
                document.getElementById('scriptsPaginationInfo').textContent = '';
                return;
            }
            
            const startIndex = (page - 1) * scriptsPerPage;
            const endIndex = Math.min(startIndex + scriptsPerPage, allScripts.length);
            const pageScripts = allScripts.slice(startIndex, endIndex);
            
            pageScripts.forEach(script => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${script.name}</td>
                    <td>${script.relative_path}</td>
                    <td>${script.path}</td>
                    <td>
                        <button class="btn btn-start" onclick="startScript('${script.path.replace(/\\/g, '\\\\')}')">启动</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 更新分页信息
            document.getElementById('scriptsPaginationInfo').textContent = 
                `显示第 ${startIndex + 1} - ${endIndex} 个脚本，共 ${allScripts.length} 个`;
        }
        
        // 设置脚本分页控件
        function setupScriptsPagination() {
            const pagination = document.getElementById('scriptsPagination');
            pagination.innerHTML = '';
            
            if (allScripts.length === 0) return;
            
            const totalPages = Math.ceil(allScripts.length / scriptsPerPage);
            
            // 上一页按钮
            if (currentPage > 1) {
                const prevButton = document.createElement('button');
                prevButton.className = 'btn btn-pagination';
                prevButton.textContent = '上一页';
                prevButton.onclick = () => {
                    currentPage--;
                    displayScriptsPage(currentPage);
                    setupScriptsPagination();
                };
                pagination.appendChild(prevButton);
            }
            
            // 页码按钮
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = 'btn btn-pagination' + (i === currentPage ? ' active' : '');
                pageButton.textContent = i;
                pageButton.onclick = () => {
                    currentPage = i;
                    displayScriptsPage(currentPage);
                    setupScriptsPagination();
                };
                pagination.appendChild(pageButton);
            }
            
            // 下一页按钮
            if (currentPage < totalPages) {
                const nextButton = document.createElement('button');
                nextButton.className = 'btn btn-pagination';
                nextButton.textContent = '下一页';
                nextButton.onclick = () => {
                    currentPage++;
                    displayScriptsPage(currentPage);
                    setupScriptsPagination();
                };
                pagination.appendChild(nextButton);
            }
        }
        
        // 启动脚本
        function startScript(scriptPath) {
            fetch('/api/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({script_path: scriptPath})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    getRunningProcesses();
                } else {
                    showNotification('错误: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error starting script:', error);
                showNotification('启动脚本时出错', 'error');
            });
        }
        
        // 停止脚本
        function stopScript(pid) {
            if (!confirm('确定要停止进程 ' + pid + ' 吗?')) {
                return;
            }
            
            fetch('/api/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({pid: pid})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    getRunningProcesses();
                } else {
                    showNotification('错误: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error stopping script:', error);
                showNotification('停止脚本时出错', 'error');
            });
        }
        
        // 查看日志
        let currentLogPid = null;
        function viewLogs(pid) {
            currentLogPid = pid;
            fetch(`/api/logs/${pid}`)
                .then(response => response.json())
                .then(data => {
                    const logContainer = document.getElementById('logContent');
                    if (data.error) {
                        logContainer.textContent = '错误: ' + data.error;
                    } else {
                        if (data.source === 'active' || data.source === 'file') {
                            logContainer.textContent = data.logs.join('\n');
                        } else if (data.source === 'process_info') {
                            logContainer.innerHTML = `
进程信息:
PID: ${data.pid}
名称: ${data.name}
命令行: ${data.cmdline}
状态: ${data.status}
启动时间: ${data.create_time}
CPU使用率: ${data.cpu_percent}%
内存信息: ${JSON.stringify(data.memory_info)}

${data.logs.join('\n')}
                            `;
                        }
                        // 滚动到底部
                        if (document.getElementById('autoScrollBtn').classList.contains('active')) {
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching logs:', error);
                    document.getElementById('logContent').textContent = '获取日志时出错: ' + error;
                });
        }
        
        // 实时日志功能
        let eventSource = null;
        function streamLogs(pid) {
            // 设置当前PID
            currentLogPid = pid;
            
            const logContainer = document.getElementById('logContent');
            logContainer.textContent = '连接到实时日志流...\n';
            
            // 关闭现有的连接
            if (eventSource) {
                eventSource.close();
            }
            
            // 建立新的SSE连接
            eventSource = new EventSource(`/api/logs/stream/${pid}`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.end) {
                    logContainer.textContent += '\n[进程已结束]\n';
                    eventSource.close();
                    return;
                }
                
                if (data.error) {
                    logContainer.textContent += '\n[错误]: ' + data.error + '\n';
                    return;
                }
                
                if (data.line) {
                    logContainer.textContent += data.line + '\n';
                    // 滚动到底部
                    if (document.getElementById('autoScrollBtn').classList.contains('active')) {
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                }
            };
            
            eventSource.onerror = function(err) {
                logContainer.textContent += '\n[连接错误]\n';
                console.error('EventSource failed:', err);
                // 关闭连接以避免重复错误
                if (eventSource) {
                    eventSource.close();
                }
            };
        }
        
        // SSH功能
        let sshConnections = {};
        let currentConsoleConnId = null;
        let consoleWebSocket = null;
        let debugMode = false;
        
        // 保存SSH连接
        function saveConnection() {
            const connData = {
                name: document.getElementById('connName').value,
                host: document.getElementById('sshHost').value,
                port: parseInt(document.getElementById('sshPort').value),
                username: document.getElementById('sshUsername').value,
                auth_method: document.getElementById('authMethod').value,
                password: document.getElementById('sshPassword').value,
                key_file: document.getElementById('sshKeyFile').value
            };
            
            // 获取当前配置
            fetch('/api/ssh/config')
                .then(response => response.json())
                .then(config => {
                    // 添加新连接或更新现有连接
                    const existingIndex = config.connections.findIndex(c => c.name === connData.name);
                    if (existingIndex >= 0) {
                        config.connections[existingIndex] = connData;
                    } else {
                        config.connections.push(connData);
                    }
                    
                    // 保存配置
                    return fetch('/api/ssh/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        loadSavedConnections();
                        // 清空表单
                        document.getElementById('sshConfigForm').reset();
                    } else {
                        showNotification('错误: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error saving connection:', error);
                    showNotification('保存连接时出错', 'error');
                });
        }
        
        // 加载已保存的连接
        function loadSavedConnections() {
            fetch('/api/ssh/config')
                .then(response => response.json())
                .then(config => {
                    const container = document.getElementById('savedConnections');
                    container.innerHTML = '';
                    
                    if (!config.connections || config.connections.length === 0) {
                        container.innerHTML = '<p>没有保存的连接</p>';
                        return;
                    }
                    
                    config.connections.forEach((conn, index) => {
                        const connId = 'conn_' + index;
                        const connDiv = document.createElement('div');
                        connDiv.className = 'ssh-connection';
                        connDiv.innerHTML = `
                            <strong>${conn.name}</strong> - ${conn.username}@${conn.host}:${conn.port}
                            <div style="margin-top: 10px;">
                                <button class="btn btn-connect" onclick="connectToServer('${connId}', ${index})">连接</button>
                                <button class="btn btn-disconnect" onclick="disconnectFromServer('${connId}')" disabled>断开</button>
                                <button class="btn btn-console" onclick="openConsole('${connId}')" disabled>控制台</button>
                                <button class="btn btn-execute" onclick="showExecuteForm('${connId}')" disabled>执行命令</button>
                            </div>
                            <div id="executeForm_${connId}" style="margin-top: 10px; display: none;">
                                <div class="command-input">
                                    <input type="text" id="command_${connId}" placeholder="输入要执行的命令">
                                    <button class="btn btn-execute" onclick="executeCommand('${connId}')">执行</button>
                                </div>
                                <div id="commandOutput_${connId}" class="log-container" style="margin-top: 10px; height: 150px;"></div>
                            </div>
                        `;
                        container.appendChild(connDiv);
                        sshConnections[connId] = {
                            config: conn,
                            connected: false
                        };
                    });
                })
                .catch(error => {
                    console.error('Error loading connections:', error);
                    showNotification('加载连接时出错', 'error');
                });
        }
        
        // 连接到服务器
        function connectToServer(connId, configIndex) {
            const conn = sshConnections[connId];
            if (!conn) {
                showNotification('连接配置未找到', 'error');
                return;
            }
            
            const connectData = {
                conn_id: connId,
                host: conn.config.host,
                port: conn.config.port,
                username: conn.config.username,
                password: conn.config.auth_method === 'password' ? conn.config.password : undefined,
                key_file: conn.config.auth_method === 'key' ? conn.config.key_file : undefined
            };
            
            fetch('/api/ssh/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(connectData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    sshConnections[connId].connected = true;
                    // 启用相关按钮
                    document.querySelectorAll(`#savedConnections .ssh-connection:nth-child(${configIndex + 1}) .btn-disconnect, 
                                              #savedConnections .ssh-connection:nth-child(${configIndex + 1}) .btn-console,
                                              #savedConnections .ssh-connection:nth-child(${configIndex + 1}) .btn-execute`)
                        .forEach(btn => {
                            btn.disabled = false;
                        });
                } else {
                    showNotification('错误: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error connecting to server:', error);
                showNotification('连接服务器时出错', 'error');
            });
        }
        
        // 断开服务器连接
        function disconnectFromServer(connId) {
            fetch('/api/ssh/disconnect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({conn_id: connId})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    sshConnections[connId].connected = false;
                    // 禁用相关按钮
                    const connDiv = document.querySelector(`#savedConnections .ssh-connection:nth-child(${Array.from(document.querySelector('#savedConnections').children).findIndex(el => el.querySelector(`button[onclick*="${connId}"]`)) + 1})`);
                    if (connDiv) {
                        connDiv.querySelectorAll('.btn-disconnect, .btn-console, .btn-execute')
                            .forEach(btn => {
                                btn.disabled = true;
                            });
                    }
                    // 隐藏执行表单
                    document.getElementById(`executeForm_${connId}`).style.display = 'none';
                } else {
                    showNotification('错误: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error disconnecting from server:', error);
                showNotification('断开连接时出错', 'error');
            });
        }
        
        // 显示执行命令表单
        function showExecuteForm(connId) {
            document.getElementById(`executeForm_${connId}`).style.display = 'block';
        }
        
        // 执行命令
        function executeCommand(connId) {
            const command = document.getElementById(`command_${connId}`).value;
            if (!command) {
                showNotification('请输入要执行的命令', 'error');
                return;
            }
            
            fetch('/api/ssh/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    conn_id: connId,
                    command: command
                })
            })
            .then(response => response.json())
            .then(data => {
                const outputDiv = document.getElementById(`commandOutput_${connId}`);
                if (data.success) {
                    const result = data.result;
                    let output = '';
                    if (result.output) {
                        output += result.output;
                    }
                    if (result.error) {
                        output += '\n[错误输出]:\n' + result.error;
                    }
                    outputDiv.textContent = output;
                    outputDiv.scrollTop = outputDiv.scrollHeight;
                } else {
                    outputDiv.textContent = '错误: ' + data.error;
                }
            })
            .catch(error => {
                console.error('Error executing command:', error);
                const outputDiv = document.getElementById(`commandOutput_${connId}`);
                outputDiv.textContent = '执行命令时出错: ' + error;
            });
        }
        
        // 打开SSH控制台
        function openConsole(connId) {
            currentConsoleConnId = connId;
            const conn = sshConnections[connId];
            
            // 设置控制台标题
            document.getElementById('consoleTitle').textContent = `SSH控制台 - ${conn.config.name} (${conn.config.username}@${conn.config.host}:${conn.config.port})`;
            
            // 显示控制台
            document.getElementById('consoleModal').style.display = 'block';
            
            // 清空输出
            document.getElementById('consoleOutput').textContent = '';
            
            // 连接WebSocket
            const wsUrl = `ws://${window.location.host}/ws/ssh_shell/${connId}`;
            consoleWebSocket = new WebSocket(wsUrl);
            
            consoleWebSocket.onopen = function(event) {
                console.log('WebSocket连接已建立');
                // 打开shell
                fetch('/api/ssh/open_shell', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({conn_id: connId})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addToConsole('Shell已打开，可以开始输入命令...\n');
                    } else {
                        addToConsole('打开Shell失败: ' + data.error + '\n');
                    }
                })
                .catch(error => {
                    addToConsole('打开Shell时出错: ' + error + '\n');
                });
            };
            
            consoleWebSocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.output) {
                        addToConsole(data.output);
                    } else if (data.error) {
                        addToConsole('[错误] ' + data.error + '\n');
                    }
                } catch (e) {
                    // 如果不是JSON，直接显示
                    addToConsole(event.data);
                }
            };
            
            consoleWebSocket.onerror = function(event) {
                addToConsole('[错误] WebSocket连接出错\n');
            };
            
            consoleWebSocket.onclose = function(event) {
                addToConsole('[信息] WebSocket连接已关闭\n');
            };
        }
        
        // 关闭控制台
        function closeConsole() {
            if (consoleWebSocket) {
                consoleWebSocket.close();
                consoleWebSocket = null;
            }
            document.getElementById('consoleModal').style.display = 'none';
            currentConsoleConnId = null;
        }
        
        // 添加内容到控制台输出
        function addToConsole(text) {
            const output = document.getElementById('consoleOutput');
            output.textContent += text;
            // 自动滚动到底部
            output.scrollTop = output.scrollHeight;
        }
        
        // 发送命令到控制台
        function sendCommand() {
            const commandInput = document.getElementById('consoleCommand');
            const command = commandInput.value;
            if (!command || !consoleWebSocket) return;
            
            // 显示发送的命令
            addToConsole('$ ' + command + '\n');
            
            // 发送到WebSocket
            consoleWebSocket.send(JSON.stringify({command: command}));
            
            // 清空输入框
            commandInput.value = '';
        }
        
        // 切换调试模式
        function toggleDebugMode() {
            debugMode = !debugMode;
            document.getElementById('debugSection').style.display = debugMode ? 'block' : 'none';
            document.querySelector('.console-input .btn-debug').textContent = debugMode ? '关闭调试' : '调试模式';
        }
        
        // 发送调试命令
        function sendDebugCommand(command) {
            const commandInput = document.getElementById('consoleCommand');
            commandInput.value = command;
            sendCommand();
        }
        
        // 监控配置功能
        function loadMonitorConfig() {
            fetch('/api/config/monitor')
                .then(response => response.json())
                .then(config => {
                    document.getElementById('monitorPaths').value = config.monitor_paths.join('\n');
                    document.getElementById('excludePatterns').value = config.exclude_patterns.join('\n');
                    
                    // 显示解析后的路径
                    const resolvedPathsDiv = document.getElementById('resolvedPaths');
                    resolvedPathsDiv.innerHTML = '<strong>解析后的路径:</strong><br>';
                    config.monitor_paths.forEach(path => {
                        let fullPath;
                        if (path.startsWith('/') || path.includes(':\\')) {
                            fullPath = path; // 绝对路径
                        } else {
                            fullPath = './' + path; // 相对路径
                        }
                        resolvedPathsDiv.innerHTML += `${fullPath}<br>`;
                    });
                })
                .catch(error => {
                    console.error('Error loading monitor config:', error);
                    showNotification('加载监控配置时出错', 'error');
                });
        }
        
        function saveMonitorConfig() {
            const monitorPaths = document.getElementById('monitorPaths').value
                .split('\n')
                .filter(path => path.trim() !== '');
            const excludePatterns = document.getElementById('excludePatterns').value
                .split('\n')
                .filter(pattern => pattern.trim() !== '');
            
            const config = {
                monitor_paths: monitorPaths,
                exclude_patterns: excludePatterns
            };
            
            fetch('/api/config/monitor', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadMonitorConfig();
                } else {
                    showNotification('错误: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving monitor config:', error);
                showNotification('保存监控配置时出错', 'error');
            });
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化系统信息
            getSystemInfo();
            
            getRunningProcesses();
            getAllScripts();
            loadSavedConnections();
            loadMonitorConfig();
            
            // 设置刷新按钮事件
            document.getElementById('refreshSystemInfo').addEventListener('click', getSystemInfo);
            document.getElementById('autoRefreshSystemInfo').addEventListener('click', toggleAutoRefreshSystemInfo);
            document.getElementById('refreshRunning').addEventListener('click', getRunningProcesses);
            document.getElementById('refreshScripts').addEventListener('click', getAllScripts);
            document.getElementById('refreshConnections').addEventListener('click', loadSavedConnections);
            document.getElementById('refreshLogsBtn').addEventListener('click', function() {
                if (currentLogPid) {
                    viewLogs(currentLogPid);
                }
            });
            
            // 保存连接按钮事件
            document.getElementById('saveConnection').addEventListener('click', saveConnection);
            
            // 实时日志按钮事件
            document.getElementById('streamLogsBtn').addEventListener('click', function() {
                if (currentLogPid) {
                    streamLogs(currentLogPid);
                } else {
                    const logContainer = document.getElementById('logContent');
                    logContainer.textContent = '请先选择一个进程来查看实时日志';
                }
            });
            
            // 自动滚动按钮事件
            document.getElementById('autoScrollBtn').addEventListener('click', function() {
                this.classList.toggle('active');
                if (this.classList.contains('active')) {
                    this.textContent = '自动滚动';
                    // 滚动到底部
                    const logContainer = document.getElementById('logContent');
                    logContainer.scrollTop = logContainer.scrollHeight;
                } else {
                    this.textContent = '自动滚动(关)';
                }
            });
            
            // 监控配置按钮事件
            document.getElementById('saveMonitorConfig').addEventListener('click', saveMonitorConfig);
            document.getElementById('loadMonitorConfig').addEventListener('click', loadMonitorConfig);
            
            // 控制台命令输入事件
            document.getElementById('consoleCommand').addEventListener('keypress', function(e) {
                if (e.keyCode === 13) {
                    sendCommand();
                }
            });
            
            // 每10秒自动刷新一次运行进程
            setInterval(() => {
                getRunningProcesses();
            }, 10000);
        });
    </script>
</body>
</html>