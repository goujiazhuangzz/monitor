<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统信息 - Python脚本监控工具</title>
    <!-- 引入Vue 3 -->
    <script src="{{ url_for('static', filename='js/vendor/vue.global.js') }}"></script>
    <!-- 引入Element Plus -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/element-plus.css') }}">
    <script src="{{ url_for('static', filename='js/vendor/element-plus.js') }}"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        
        #app {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin: 0;
            color: #303133;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-title {
            margin-top: 0;
            margin-bottom: 20px;
            color: #303133;
            border-bottom: 1px solid #ebeef5;
            padding-bottom: 10px;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-label {
            width: 80px;
            font-weight: 500;
            color: #606266;
        }
        
        .progress-bar {
            flex: 1;
            margin: 0 10px;
        }
        
        .progress-text {
            width: 50px;
            text-align: right;
            font-size: 14px;
            color: #909399;
        }
        
        .disk-item {
            padding: 15px;
            background-color: #f5f7fa;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .disk-header {
            font-weight: 500;
            margin-bottom: 8px;
            color: #303133;
        }
        
        .disk-usage {
            font-size: 14px;
            color: #606266;
            margin-bottom: 8px;
        }
        
        .process-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .process-table th,
        .process-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #ebeef5;
        }
        
        .process-table th {
            background-color: #f5f7fa;
            font-weight: 500;
            color: #909399;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .notification.success {
            background-color: #67c23a;
        }
        
        .notification.error {
            background-color: #f56c6c;
        }
        
        .menu {
            display: flex;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 10px;
        }
        
        .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .menu-item.active {
            background-color: #409eff;
            color: white;
        }
        
        .menu-item:hover:not(.active) {
            background-color: #f5f7fa;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>Python脚本监控工具</h1>
            <div class="user-info">
                <span>欢迎, {{ session.username }}!</span>
                <el-button type="primary" @click="showChangePasswordDialog = true">修改密码</el-button>
                <a href="{{ url_for('auth.logout') }}">
                    <el-button type="danger">注销</el-button>
                </a>
            </div>
        </div>
        
        <div class="menu">
            <div class="menu-item" :class="{ active: activeMenu === 'system' }" @click="navigateTo('system')">系统信息</div>
            <div class="menu-item" :class="{ active: activeMenu === 'local' }" @click="navigateTo('local')">本地脚本管理</div>
            <div class="menu-item" :class="{ active: activeMenu === 'ssh' }" @click="navigateTo('ssh')">SSH远程连接</div>
            <div class="menu-item" :class="{ active: activeMenu === 'config' }" @click="navigateTo('config')">配置管理</div>
        </div>
        
        <system-info></system-info>
        
        <!-- 修改密码对话框 -->
        <el-dialog v-model="showChangePasswordDialog" title="修改密码" width="400px">
            <el-form :model="passwordForm" ref="passwordFormRef">
                <el-form-item label="当前密码" prop="currentPassword">
                    <el-input v-model="passwordForm.currentPassword" type="password" show-password></el-input>
                </el-form-item>
                <el-form-item label="新密码" prop="newPassword">
                    <el-input v-model="passwordForm.newPassword" type="password" show-password></el-input>
                </el-form-item>
                <el-form-item label="确认新密码" prop="confirmPassword">
                    <el-input v-model="passwordForm.confirmPassword" type="password" show-password></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showChangePasswordDialog = false">取消</el-button>
                    <el-button type="primary" @click="changePassword">确定</el-button>
                </span>
            </template>
        </el-dialog>
        
        <!-- 通知消息 -->
        <div v-if="notification && notification.message" 
             :class="['notification', notification.type]"
             @click="hideNotification">
            {[{ notification.message }]}
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, onBeforeUnmount, computed, provide, inject } = Vue;
        const { ElButton, ElTabs, ElTabPane, ElDialog, ElForm, ElFormItem, ElInput, ElCard, 
                ElRow, ElCol, ElProgress, ElTable, ElTableColumn, ElTag, ElMessageBox } = ElementPlus;
        
        // 系统信息组件
        const SystemInfo = {
            template: `
                <div>
                    <el-row :gutter="20">
                        <el-col :span="24" style="margin-bottom: 20px;">
                            <el-card>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3 style="margin: 0;">系统信息</h3>
                                    <div>
                                        <el-button @click="fetchSystemInfo">刷新</el-button>
                                        <el-button @click="toggleAutoRefresh" 
                                                   :type="autoRefresh ? 'success' : 'default'">
                                            {[{ getAutoRefreshText() }]}
                                        </el-button>
                                        <el-button @click="toggleCollapse">
                                            {[{ getCollapseText() }]}
                                        </el-button>
                                    </div>
                                </div>
                            </el-card>
                        </el-col>
                    </el-row>
                    
                    <div v-show="!collapsed">
                        <el-row :gutter="20">
                            <el-col :span="8">
                                <el-card>
                                    <h3 style="margin-top: 0;">CPU信息</h3>
                                    <div class="progress-container">
                                        <span class="progress-label">使用率:</span>
                                        <el-progress 
                                            class="progress-bar" 
                                            :percentage="Math.round(systemInfo.cpu.percent)" 
                                            :show-text="false">
                                        </el-progress>
                                        <span class="progress-text">{[{ getCpuPercentText(systemInfo.cpu.percent )}]}</span>
                                    </div>
                                    <p>核心数: {[{ systemInfo.cpu.count }]}</p>
                                    
                                    <h4>Top 5 进程</h4>
                                    <el-table :data="systemInfo.top_processes.cpu" style="width: 100%" size="small">
                                        <el-table-column prop="pid" label="PID" width="80"></el-table-column>
                                        <el-table-column prop="name" label="进程名"></el-table-column>
                                        <el-table-column prop="cpu_percent" label="CPU%" width="80">
                                            <template #default="scope">
                                                {[{ getCpuPercentText(scope.row.cpu_percent) }]}
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="操作" width="80">
                                            <template #default="scope">
                                                <el-button size="small" type="danger" 
                                                           @click="killProcess(scope.row.pid)">杀掉</el-button>
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                </el-card>
                            </el-col>
                            
                            <el-col :span="8">
                                <el-card>
                                    <h3 style="margin-top: 0;">内存信息</h3>
                                    <div class="progress-container">
                                        <span class="progress-label">使用率:</span>
                                        <el-progress 
                                            class="progress-bar" 
                                            :percentage="Math.round(systemInfo.memory.percent)" 
                                            :show-text="false">
                                        </el-progress>
                                        <span class="progress-text">{[{ getMemoryPercentText(systemInfo.memory.percent) }]}</span>
                                    </div>
                                    <p>已用: {[{ (systemInfo.memory.used / (1024**3)).toFixed(2) }]} GB</p>
                                    <p>总量: {[{ (systemInfo.memory.total / (1024**3)).toFixed(2) }]} GB</p>
                                    
                                    <h4>Top 5 内存占用</h4>
                                    <el-table :data="systemInfo.top_processes.memory" style="width: 100%" size="small">
                                        <el-table-column prop="pid" label="PID" width="80"></el-table-column>
                                        <el-table-column prop="name" label="进程名"></el-table-column>
                                        <el-table-column prop="memory_percent" label="内存使用" width="100">
                                            <template #default="scope">
                                                {[{ getMemoryPercentText(scope.row.memory_percent) }]}
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="操作" width="80">
                                            <template #default="scope">
                                                <el-button size="small" type="danger" 
                                                           @click="killProcess(scope.row.pid)">杀掉</el-button>
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                </el-card>
                            </el-col>
                            
                            <el-col :span="8">
                                <el-card>
                                    <h3 style="margin-top: 0;">磁盘信息</h3>
                                    <div v-for="disk in systemInfo.disks" :key="disk.device" class="disk-item">
                                        <div class="disk-header">{[{ disk.device }]} ({[{ disk.mountpoint }]})</div>
                                        <div class="disk-usage">
                                            {[{ getDiskUsageText(disk) }]}
                                        </div>
                                        <el-progress 
                                            :percentage="Math.round(disk.percent)" 
                                            :show-text="false">
                                        </el-progress>
                                    </div>
                                </el-card>
                            </el-col>
                        </el-row>
                    </div>
                </div>
            `,
            setup() {
                const systemInfo = reactive({
                    cpu: { percent: 0, count: 0 },
                    memory: { percent: 0, used: 0, total: 0 },
                    disks: [],
                    top_processes: { cpu: [], memory: [] }
                });
                
                const collapsed = ref(false);
                const autoRefresh = ref(false);
                const refreshInterval = ref(null);
                
                const getAutoRefreshText = () => {
                    return autoRefresh.value ? '停止自动刷新' : '自动刷新';
                };
                
                const getCollapseText = () => {
                    return collapsed.value ? '展开' : '折叠';
                };
                
                const getCpuPercentText = (cpuPercent) => {
                    return cpuPercent !== null ? cpuPercent.toFixed(1) + '%' : 'N/A';
                };
                
                const getMemoryPercentText = (memoryPercent) => {
                    return memoryPercent !== null ? memoryPercent.toFixed(1) + '%' : 'N/A';
                };
                
                const getDiskUsageText = (disk) => {
                    const usedGB = (disk.used / (1024**3)).toFixed(2);
                    const totalGB = (disk.total / (1024**3)).toFixed(2);
                    const percent = disk.percent.toFixed(1);
                    return `${usedGB} GB / ${totalGB} GB (${percent}%)`;
                };
                
                const fetchSystemInfo = async () => {
                    try {
                        const response = await fetch('/api/system/info');
                        if (response.status === 401) {
                            window.location.href = '/login';
                            return;
                        }
                        const data = await response.json();
                        if (data && !data.error) {
                            Object.assign(systemInfo, data);
                        }
                    } catch (error) {
                        console.error('获取系统信息失败:', error);
                    }
                };
                
                const toggleCollapse = () => {
                    collapsed.value = !collapsed.value;
                };
                
                const toggleAutoRefresh = () => {
                    autoRefresh.value = !autoRefresh.value;
                    if (autoRefresh.value) {
                        refreshInterval.value = setInterval(fetchSystemInfo, 5000);
                    } else {
                        clearInterval(refreshInterval.value);
                    }
                };
                
                const killProcess = async (pid) => {
                    try {
                        await ElMessageBox.confirm(
                            `确定要杀掉进程 ${pid} 吗?`,
                            '确认操作',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning',
                            }
                        );
                        
                        const response = await fetch('/api/kill', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ pid: pid })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            const emit = inject('emit');
                            emit('show-notification', { message: `进程 ${pid} 已成功杀掉`, type: 'success' });
                            fetchSystemInfo();
                        } else {
                            const emit = inject('emit');
                            emit('show-notification', { message: `杀掉进程失败: ${data.error}`, type: 'error' });
                        }
                    } catch {
                        // 用户取消操作
                    }
                };
                
                // 组件挂载时获取初始数据
                onMounted(() => {
                    fetchSystemInfo();
                });
                
                // 组件卸载前清理定时器
                onBeforeUnmount(() => {
                    if (refreshInterval.value) {
                        clearInterval(refreshInterval.value);
                    }
                });
                
                return {
                    systemInfo,
                    collapsed,
                    autoRefresh,
                    getAutoRefreshText,
                    getCollapseText,
                    getCpuPercentText,
                    getMemoryPercentText,
                    getDiskUsageText,
                    fetchSystemInfo,
                    toggleCollapse,
                    toggleAutoRefresh,
                    killProcess
                };
            }
        };
        
        // 主应用
        const app = createApp({
            components: {
                SystemInfo
            },
            setup() {
                const activeMenu = ref('system');
                const showChangePasswordDialog = ref(false);
                const passwordForm = reactive({
                    currentPassword: '',
                    newPassword: '',
                    confirmPassword: ''
                });
                const passwordFormRef = ref(null);
                const notification = reactive({
                    message: '',
                    type: 'success'
                });
                const notificationTimeout = ref(null);
                
                const showNotification = (data) => {
                    notification.message = data.message;
                    notification.type = data.type;
                    
                    // 清除之前的定时器
                    if (notificationTimeout.value) {
                        clearTimeout(notificationTimeout.value);
                    }
                    
                    // 3秒后自动隐藏通知
                    notificationTimeout.value = setTimeout(() => {
                        notification.message = '';
                    }, 3000);
                };
                
                const hideNotification = () => {
                    notification.message = '';
                    if (notificationTimeout.value) {
                        clearTimeout(notificationTimeout.value);
                    }
                };
                
                const changePassword = async () => {
                    if (passwordForm.newPassword !== passwordForm.confirmPassword) {
                        showNotification({ message: '新密码和确认密码不匹配', type: 'error' });
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/auth/change_password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                current_password: passwordForm.currentPassword,
                                new_password: passwordForm.newPassword
                            })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            showNotification({ message: data.message, type: 'success' });
                            showChangePasswordDialog.value = false;
                            // 清空表单
                            Object.assign(passwordForm, {
                                currentPassword: '',
                                newPassword: '',
                                confirmPassword: ''
                            });
                        } else {
                            showNotification({ message: `修改密码失败: ${data.error}`, type: 'error' });
                        }
                    } catch (error) {
                        showNotification({ message: '修改密码时出错', type: 'error' });
                    }
                };
                
                const navigateTo = (menu) => {
                    activeMenu.value = menu;
                    switch(menu) {
                        case 'system':
                            window.location.href = '/system_info';
                            break;
                        case 'local':
                            window.location.href = '/local_scripts';
                            break;
                        case 'ssh':
                            window.location.href = '/ssh_connections';
                            break;
                        case 'config':
                            window.location.href = '/config_manager';
                            break;
                    }
                };
                
                // 提供全局事件
                const emit = (event, data) => {
                    if (event === 'show-notification') {
                        showNotification(data);
                    }
                };
                
                provide('emit', emit);
                
                return {
                    activeMenu,
                    showChangePasswordDialog,
                    passwordForm,
                    passwordFormRef,
                    notification,
                    showNotification,
                    hideNotification,
                    changePassword,
                    navigateTo
                };
            }
        });
        
        app.config.compilerOptions.delimiters = ['{[{', '}]}'];
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>