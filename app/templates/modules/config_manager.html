<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理 - Python脚本监控工具</title>
    <!-- 引入Vue 3 -->
    <script src="{{ url_for('static', filename='js/vendor/vue.global.js') }}"></script>
    <!-- 引入Element Plus -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/element-plus.css') }}">
    <script src="{{ url_for('static', filename='js/vendor/element-plus.js') }}"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        
        #app {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin: 0;
            color: #303133;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-title {
            margin-top: 0;
            margin-bottom: 20px;
            color: #303133;
            border-bottom: 1px solid #ebeef5;
            padding-bottom: 10px;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-label {
            width: 80px;
            font-weight: 500;
            color: #606266;
        }
        
        .progress-bar {
            flex: 1;
            margin: 0 10px;
        }
        
        .progress-text {
            width: 50px;
            text-align: right;
            font-size: 14px;
            color: #909399;
        }
        
        .disk-item {
            padding: 15px;
            background-color: #f5f7fa;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .disk-header {
            font-weight: 500;
            margin-bottom: 8px;
            color: #303133;
        }
        
        .disk-usage {
            font-size: 14px;
            color: #606266;
            margin-bottom: 8px;
        }
        
        .process-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .process-table th,
        .process-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #ebeef5;
        }
        
        .process-table th {
            background-color: #f5f7fa;
            font-weight: 500;
            color: #909399;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .notification.success {
            background-color: #67c23a;
        }
        
        .notification.error {
            background-color: #f56c6c;
        }
        
        .menu {
            display: flex;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 10px;
        }
        
        .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .menu-item.active {
            background-color: #409eff;
            color: white;
        }
        
        .menu-item:hover:not(.active) {
            background-color: #f5f7fa;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>Python脚本监控工具</h1>
            <div class="user-info">
                <span>欢迎, {{ session.username }}!</span>
                <el-button type="primary" @click="showChangePasswordDialog = true">修改密码</el-button>
                <a href="{{ url_for('auth.logout') }}">
                    <el-button type="danger">注销</el-button>
                </a>
            </div>
        </div>
        
        <div class="menu">
            <div class="menu-item" :class="{ active: activeMenu === 'system' }" @click="navigateTo('system')">系统信息</div>
            <div class="menu-item" :class="{ active: activeMenu === 'local' }" @click="navigateTo('local')">本地脚本管理</div>
            <div class="menu-item" :class="{ active: activeMenu === 'ssh' }" @click="navigateTo('ssh')">SSH远程连接</div>
            <div class="menu-item" :class="{ active: activeMenu === 'config' }" @click="navigateTo('config')">配置管理</div>
        </div>
        
        <config-manager></config-manager>
        
        <!-- 修改密码对话框 -->
        <el-dialog v-model="showChangePasswordDialog" title="修改密码" width="400px">
            <el-form :model="passwordForm" ref="passwordFormRef">
                <el-form-item label="当前密码" prop="currentPassword">
                    <el-input v-model="passwordForm.currentPassword" type="password" show-password></el-input>
                </el-form-item>
                <el-form-item label="新密码" prop="newPassword">
                    <el-input v-model="passwordForm.newPassword" type="password" show-password></el-input>
                </el-form-item>
                <el-form-item label="确认新密码" prop="confirmPassword">
                    <el-input v-model="passwordForm.confirmPassword" type="password" show-password></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showChangePasswordDialog = false">取消</el-button>
                    <el-button type="primary" @click="changePassword">确定</el-button>
                </span>
            </template>
        </el-dialog>
        
        <!-- 通知消息 -->
        <div v-if="notification && notification.message" 
             :class="['notification', notification.type]"
             @click="hideNotification">
            {[{ notification.message }]}
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, onBeforeUnmount, computed, provide, inject } = Vue;
        const { ElButton, ElTabs, ElTabPane, ElDialog, ElForm, ElFormItem, ElInput, ElCard, 
                ElRow, ElCol, ElProgress, ElTable, ElTableColumn, ElTag, ElMessageBox } = ElementPlus;
        
        // 配置管理组件
        const ConfigManager = {
            template: `
                <div>
                    <el-card style="margin-bottom: 20px;">
                        <h3 style="margin-top: 0;">监控配置</h3>
                        <el-form :model="configForm" label-width="120px">
                            <el-form-item label="监控路径">
                                <el-input 
                                    v-model="configForm.monitor_paths" 
                                    type="textarea" 
                                    :rows="4"
                                    placeholder="每行一个路径">
                                </el-input>
                            </el-form-item>
                            
                            <el-form-item label="排除模式">
                                <el-input 
                                    v-model="configForm.exclude_patterns" 
                                    type="textarea" 
                                    :rows="4"
                                    placeholder="每行一个模式">
                                </el-input>
                            </el-form-item>
                            
                            <el-form-item>
                                <el-button type="primary" @click="saveConfig">保存配置</el-button>
                                <el-button @click="loadConfig">加载配置</el-button>
                            </el-form-item>
                        </el-form>
                    </el-card>
                </div>
            `,
            setup() {
                const configForm = reactive({
                    monitor_paths: '',
                    exclude_patterns: ''
                });
                
                const loadConfig = async () => {
                    try {
                        const response = await fetch('/api/config/monitor');
                        if (response.status === 401) {
                            window.location.href = '/login';
                            return;
                        }
                        const data = await response.json();
                        configForm.monitor_paths = (data.monitor_paths || []).join('\n');
                        configForm.exclude_patterns = (data.exclude_patterns || []).join('\n');
                    } catch (error) {
                        console.error('加载配置失败:', error);
                    }
                };
                
                const saveConfig = async () => {
                    try {
                        const config = {
                            monitor_paths: configForm.monitor_paths.split('\n').filter(path => path.trim() !== ''),
                            exclude_patterns: configForm.exclude_patterns.split('\n').filter(pattern => pattern.trim() !== '')
                        };
                        
                        const response = await fetch('/api/config/monitor', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(config)
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            const emit = inject('emit');
                            emit('show-notification', { message: data.message, type: 'success' });
                        } else {
                            const emit = inject('emit');
                            emit('show-notification', { message: `保存配置失败: ${data.error}`, type: 'error' });
                        }
                    } catch (error) {
                        const emit = inject('emit');
                        emit('show-notification', { message: '保存配置时出错', type: 'error' });
                    }
                };
                
                onMounted(() => {
                    loadConfig();
                });
                
                return {
                    configForm,
                    loadConfig,
                    saveConfig
                };
            }
        };
        
        // 主应用
        const app = createApp({
            components: {
                ConfigManager
            },
            setup() {
                const activeMenu = ref('config');
                const showChangePasswordDialog = ref(false);
                const passwordForm = reactive({
                    currentPassword: '',
                    newPassword: '',
                    confirmPassword: ''
                });
                const passwordFormRef = ref(null);
                const notification = reactive({
                    message: '',
                    type: 'success'
                });
                const notificationTimeout = ref(null);
                
                const showNotification = (data) => {
                    notification.message = data.message;
                    notification.type = data.type;
                    
                    // 清除之前的定时器
                    if (notificationTimeout.value) {
                        clearTimeout(notificationTimeout.value);
                    }
                    
                    // 3秒后自动隐藏通知
                    notificationTimeout.value = setTimeout(() => {
                        notification.message = '';
                    }, 3000);
                };
                
                const hideNotification = () => {
                    notification.message = '';
                    if (notificationTimeout.value) {
                        clearTimeout(notificationTimeout.value);
                    }
                };
                
                const changePassword = async () => {
                    if (passwordForm.newPassword !== passwordForm.confirmPassword) {
                        showNotification({ message: '新密码和确认密码不匹配', type: 'error' });
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/auth/change_password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                current_password: passwordForm.currentPassword,
                                new_password: passwordForm.newPassword
                            })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            showNotification({ message: data.message, type: 'success' });
                            showChangePasswordDialog.value = false;
                            // 清空表单
                            Object.assign(passwordForm, {
                                currentPassword: '',
                                newPassword: '',
                                confirmPassword: ''
                            });
                        } else {
                            showNotification({ message: `修改密码失败: ${data.error}`, type: 'error' });
                        }
                    } catch (error) {
                        showNotification({ message: '修改密码时出错', type: 'error' });
                    }
                };
                
                const navigateTo = (menu) => {
                    activeMenu.value = menu;
                    switch(menu) {
                        case 'system':
                            window.location.href = '/system_info';
                            break;
                        case 'local':
                            window.location.href = '/local_scripts';
                            break;
                        case 'ssh':
                            window.location.href = '/ssh_connections';
                            break;
                        case 'config':
                            window.location.href = '/config_manager';
                            break;
                    }
                };
                
                // 提供全局事件
                const emit = (event, data) => {
                    if (event === 'show-notification') {
                        showNotification(data);
                    }
                };
                
                provide('emit', emit);
                
                return {
                    activeMenu,
                    showChangePasswordDialog,
                    passwordForm,
                    passwordFormRef,
                    notification,
                    showNotification,
                    hideNotification,
                    changePassword,
                    navigateTo
                };
            }
        });
        
        app.config.compilerOptions.delimiters = ['{[{', '}]}'];
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>