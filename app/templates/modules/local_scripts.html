<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本地脚本管理 - Python脚本监控工具</title>
    <!-- 引入Vue 3 -->
    <script src="{{ url_for('static', filename='js/vendor/vue.global.js') }}"></script>
    <!-- 引入Element Plus -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/element-plus.css') }}">
    <script src="{{ url_for('static', filename='js/vendor/element-plus.js') }}"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        
        #app {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin: 0;
            color: #303133;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-title {
            margin-top: 0;
            margin-bottom: 20px;
            color: #303133;
            border-bottom: 1px solid #ebeef5;
            padding-bottom: 10px;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-label {
            width: 80px;
            font-weight: 500;
            color: #606266;
        }
        
        .progress-bar {
            flex: 1;
            margin: 0 10px;
        }
        
        .progress-text {
            width: 50px;
            text-align: right;
            font-size: 14px;
            color: #909399;
        }
        
        .disk-item {
            padding: 15px;
            background-color: #f5f7fa;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .disk-header {
            font-weight: 500;
            margin-bottom: 8px;
            color: #303133;
        }
        
        .disk-usage {
            font-size: 14px;
            color: #606266;
            margin-bottom: 8px;
        }
        
        .process-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .process-table th,
        .process-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #ebeef5;
        }
        
        .process-table th {
            background-color: #f5f7fa;
            font-weight: 500;
            color: #909399;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .notification.success {
            background-color: #67c23a;
        }
        
        .notification.error {
            background-color: #f56c6c;
        }
        
        .menu {
            display: flex;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 10px;
        }
        
        .menu-item {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .menu-item.active {
            background-color: #409eff;
            color: white;
        }
        
        .menu-item:hover:not(.active) {
            background-color: #f5f7fa;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>Python脚本监控工具</h1>
            <div class="user-info">
                <span>欢迎, {{ session.username }}!</span>
                <el-button type="primary" @click="showChangePasswordDialog = true">修改密码</el-button>
                <a href="{{ url_for('auth.logout') }}">
                    <el-button type="danger">注销</el-button>
                </a>
            </div>
        </div>
        
        <div class="menu">
            <div class="menu-item" :class="{ active: activeMenu === 'system' }" @click="navigateTo('system')">系统信息</div>
            <div class="menu-item" :class="{ active: activeMenu === 'local' }" @click="navigateTo('local')">本地脚本管理</div>
            <div class="menu-item" :class="{ active: activeMenu === 'ssh' }" @click="navigateTo('ssh')">SSH远程连接</div>
            <div class="menu-item" :class="{ active: activeMenu === 'config' }" @click="navigateTo('config')">配置管理</div>
        </div>
        
        <local-scripts></local-scripts>
        
        <!-- 修改密码对话框 -->
        <el-dialog v-model="showChangePasswordDialog" title="修改密码" width="400px">
            <el-form :model="passwordForm" ref="passwordFormRef">
                <el-form-item label="当前密码" prop="currentPassword">
                    <el-input v-model="passwordForm.currentPassword" type="password" show-password></el-input>
                </el-form-item>
                <el-form-item label="新密码" prop="newPassword">
                    <el-input v-model="passwordForm.newPassword" type="password" show-password></el-input>
                </el-form-item>
                <el-form-item label="确认新密码" prop="confirmPassword">
                    <el-input v-model="passwordForm.confirmPassword" type="password" show-password></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showChangePasswordDialog = false">取消</el-button>
                    <el-button type="primary" @click="changePassword">确定</el-button>
                </span>
            </template>
        </el-dialog>
        
        <!-- 通知消息 -->
        <div v-if="notification && notification.message" 
             :class="['notification', notification.type]"
             @click="hideNotification">
            {[{ notification.message }]}
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, onBeforeUnmount, computed, provide, inject } = Vue;
        const { ElButton, ElTabs, ElTabPane, ElDialog, ElForm, ElFormItem, ElInput, ElCard, 
                ElRow, ElCol, ElProgress, ElTable, ElTableColumn, ElTag, ElMessageBox, ElPagination } = ElementPlus;
        
        // 本地脚本管理组件
        const LocalScripts = {
            template: `
                <div>
                    <el-card style="margin-bottom: 20px;">
                        <h3 style="margin-top: 0;">运行中的脚本</h3>
                        <el-button @click="fetchRunningProcesses" style="float: right;">刷新</el-button>
                        <div style="clear: both;"></div>
                        <el-table :data="runningProcesses" style="width: 100%">
                            <el-table-column prop="pid" label="PID" width="100"></el-table-column>
                            <el-table-column prop="script_name" label="脚本名称"></el-table-column>
                            <el-table-column prop="script_path" label="完整路径"></el-table-column>
                            <el-table-column prop="start_time" label="启动时间"></el-table-column>
                            <el-table-column label="操作" width="250">
                                <template #default="scope">
                                    <div class="action-buttons">
                                        <el-button size="small" type="primary" 
                                                   @click="viewLogs(scope.row.pid)">查看日志</el-button>
                                        <el-button size="small" type="success" 
                                                   @click="streamLogs(scope.row.pid)">实时日志</el-button>
                                        <el-button size="small" type="danger" 
                                                   @click="stopScript(scope.row.pid)">停止</el-button>
                                    </div>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                    
                    <el-card>
                        <h3 style="margin-top: 0;">所有脚本</h3>
                        <el-button @click="fetchAllScripts" style="float: right;">刷新</el-button>
                        <div style="clear: both;"></div>
                        <p>总共 {[{ allScripts.length }]} 个脚本</p>
                        <el-table :data="paginatedScripts" style="width: 100%">
                            <el-table-column prop="name" label="脚本名称"></el-table-column>
                            <el-table-column prop="relative_path" label="相对路径"></el-table-column>
                            <el-table-column prop="path" label="完整路径"></el-table-column>
                            <el-table-column label="操作" width="100">
                                <template #default="scope">
                                    <el-button size="small" type="primary" 
                                               @click="startScript(scope.row.path)">启动</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        <div style="margin-top: 20px; text-align: center;">
                            <el-pagination
                                @current-change="handlePageChange"
                                :current-page="currentPage"
                                :page-size="scriptsPerPage"
                                :total="allScripts.length"
                                layout="prev, pager, next"
                                background>
                            </el-pagination>
                        </div>
                    </el-card>
                    
                    <!-- 日志对话框 -->
                    <el-dialog v-model="showLogDialog" :title="logDialogTitle" width="80%">
                        <pre style="background-color: #000; color: #00ff00; padding: 15px; border-radius: 4px; max-height: 400px; overflow-y: auto;">{[{ logContent }]}</pre>
                        <template #footer>
                            <span class="dialog-footer">
                                <el-button @click="showLogDialog = false">关闭</el-button>
                                <el-button v-if="streamingLogs" type="danger" @click="stopStreamingLogs">停止流式日志</el-button>
                                <el-button v-else type="primary" @click="streamLogs(currentLogPid)">开始流式日志</el-button>
                            </span>
                        </template>
                    </el-dialog>
                </div>
            `,
            setup() {
                const runningProcesses = ref([]);
                const allScripts = ref([]);
                const currentPage = ref(1);
                const scriptsPerPage = ref(5);
                const showLogDialog = ref(false);
                const logDialogTitle = ref('');
                const logContent = ref('');
                const currentLogPid = ref(null);
                const streamingLogs = ref(false);
                const logStreamEventSource = ref(null);
                
                const paginatedScripts = computed(() => {
                    const start = (currentPage.value - 1) * scriptsPerPage.value;
                    const end = start + scriptsPerPage.value;
                    return allScripts.value.slice(start, end);
                });
                
                const fetchRunningProcesses = async () => {
                    try {
                        const response = await fetch('/api/processes');
                        if (response.status === 401) {
                            window.location.href = '/login';
                            return;
                        }
                        runningProcesses.value = await response.json();
                    } catch (error) {
                        console.error('获取运行进程失败:', error);
                    }
                };
                
                const fetchAllScripts = async () => {
                    try {
                        const response = await fetch('/api/scripts');
                        if (response.status === 401) {
                            window.location.href = '/login';
                            return;
                        }
                        allScripts.value = await response.json();
                    } catch (error) {
                        console.error('获取所有脚本失败:', error);
                    }
                };
                
                const handlePageChange = (page) => {
                    currentPage.value = page;
                };
                
                const startScript = async (scriptPath) => {
                    try {
                        const response = await fetch('/api/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ script_path: scriptPath })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            const emit = inject('emit');
                            emit('show-notification', { message: data.message, type: 'success' });
                            fetchRunningProcesses();
                        } else {
                            const emit = inject('emit');
                            emit('show-notification', { message: `启动脚本失败: ${data.error}`, type: 'error' });
                        }
                    } catch (error) {
                        const emit = inject('emit');
                        emit('show-notification', { message: '启动脚本时出错', type: 'error' });
                    }
                };
                
                const stopScript = async (pid) => {
                    try {
                        await ElMessageBox.confirm(
                            `确定要停止进程 ${pid} 吗?`,
                            '确认操作',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning',
                            }
                        );
                        
                        const response = await fetch('/api/stop', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ pid: pid })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            const emit = inject('emit');
                            emit('show-notification', { message: data.message, type: 'success' });
                            fetchRunningProcesses();
                        } else {
                            const emit = inject('emit');
                            emit('show-notification', { message: `停止进程失败: ${data.error}`, type: 'error' });
                        }
                    } catch {
                        // 用户取消操作
                    }
                };
                
                const viewLogs = async (pid) => {
                    try {
                        const response = await fetch(`/api/logs/${pid}`);
                        if (response.ok) {
                            logContent.value = await response.text();
                            logDialogTitle.value = `脚本日志 (PID: ${pid})`;
                            currentLogPid.value = pid;
                            showLogDialog.value = true;
                            streamingLogs.value = false;
                        }
                    } catch (error) {
                        const emit = inject('emit');
                        emit('show-notification', { message: '获取日志失败', type: 'error' });
                    }
                };
                
                const streamLogs = (pid) => {
                    stopStreamingLogs();
                    logDialogTitle.value = `实时日志 (PID: ${pid})`;
                    currentLogPid.value = pid;
                    showLogDialog.value = true;
                    streamingLogs.value = true;
                    
                    logStreamEventSource.value = new EventSource(`/api/logs/stream/${pid}`);
                    logStreamEventSource.value.onmessage = (event) => {
                        logContent.value += event.data + '\n';
                    };
                    
                    logStreamEventSource.value.onerror = () => {
                        const emit = inject('emit');
                        emit('show-notification', { message: '日志流连接错误', type: 'error' });
                    };
                };
                
                const stopStreamingLogs = () => {
                    if (logStreamEventSource.value) {
                        logStreamEventSource.value.close();
                        logStreamEventSource.value = null;
                    }
                    streamingLogs.value = false;
                };
                
                onMounted(() => {
                    fetchRunningProcesses();
                    fetchAllScripts();
                });
                
                onBeforeUnmount(() => {
                    stopStreamingLogs();
                });
                
                return {
                    runningProcesses,
                    allScripts,
                    currentPage,
                    scriptsPerPage,
                    paginatedScripts,
                    showLogDialog,
                    logDialogTitle,
                    logContent,
                    currentLogPid,
                    streamingLogs,
                    fetchRunningProcesses,
                    fetchAllScripts,
                    handlePageChange,
                    startScript,
                    stopScript,
                    viewLogs,
                    streamLogs,
                    stopStreamingLogs
                };
            }
        };
        
        // 主应用
        const app = createApp({
            components: {
                LocalScripts
            },
            setup() {
                const activeMenu = ref('local');
                const showChangePasswordDialog = ref(false);
                const passwordForm = reactive({
                    currentPassword: '',
                    newPassword: '',
                    confirmPassword: ''
                });
                const passwordFormRef = ref(null);
                const notification = reactive({
                    message: '',
                    type: 'success'
                });
                const notificationTimeout = ref(null);
                
                const showNotification = (data) => {
                    notification.message = data.message;
                    notification.type = data.type;
                    
                    // 清除之前的定时器
                    if (notificationTimeout.value) {
                        clearTimeout(notificationTimeout.value);
                    }
                    
                    // 3秒后自动隐藏通知
                    notificationTimeout.value = setTimeout(() => {
                        notification.message = '';
                    }, 3000);
                };
                
                const hideNotification = () => {
                    notification.message = '';
                    if (notificationTimeout.value) {
                        clearTimeout(notificationTimeout.value);
                    }
                };
                
                const changePassword = async () => {
                    if (passwordForm.newPassword !== passwordForm.confirmPassword) {
                        showNotification({ message: '新密码和确认密码不匹配', type: 'error' });
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/auth/change_password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                current_password: passwordForm.currentPassword,
                                new_password: passwordForm.newPassword
                            })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            showNotification({ message: data.message, type: 'success' });
                            showChangePasswordDialog.value = false;
                            // 清空表单
                            Object.assign(passwordForm, {
                                currentPassword: '',
                                newPassword: '',
                                confirmPassword: ''
                            });
                        } else {
                            showNotification({ message: `修改密码失败: ${data.error}`, type: 'error' });
                        }
                    } catch (error) {
                        showNotification({ message: '修改密码时出错', type: 'error' });
                    }
                };
                
                const navigateTo = (menu) => {
                    activeMenu.value = menu;
                    switch(menu) {
                        case 'system':
                            window.location.href = '/system_info';
                            break;
                        case 'local':
                            window.location.href = '/local_scripts';
                            break;
                        case 'ssh':
                            window.location.href = '/ssh_connections';
                            break;
                        case 'config':
                            window.location.href = '/config_manager';
                            break;
                    }
                };
                
                // 提供全局事件
                const emit = (event, data) => {
                    if (event === 'show-notification') {
                        showNotification(data);
                    }
                };
                
                provide('emit', emit);
                
                return {
                    activeMenu,
                    showChangePasswordDialog,
                    passwordForm,
                    passwordFormRef,
                    notification,
                    showNotification,
                    hideNotification,
                    changePassword,
                    navigateTo
                };
            }
        });
        
        app.config.compilerOptions.delimiters = ['{[{', '}]}'];
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>